<!DOCTYPE html>
<html>
    <head>
        <title>smartMirror</title>
        <script src="http://code.jquery.com/jquery-latest.js" type="text/javascript"></script>
        <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js" type="text/javascript"></script>
        <script type="text/javascript">
            if (!('webkitSpeechRecognition' in window)) {
                alert("Speech API not supported here");
            } else {
                var recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = "en-GB";
            }

            recognition.onstart = function () {
            }

            recognition.onend = function () {
                recognition.start();
            }

            recognition.start();
            recognition.onresult = function (event) {

                if (typeof (event.results) === 'undefined') {
                    recognition.stop();
                    return;
                }

                for (var i = event.resultIndex; i < event.results.length; ++i) {
                    var output = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        var m = output.includes("mirror mirror");
                        if (mirrorMirrorBeenSaid == true) {
                            $("#input").text(output);
							$("marquee").css('visibility', 'hidden');
                            send();
                            mirrorMirrorBeenSaid = false;
                            setTimeout(function () {
                                $("#input").text("");
                            }, 2000);
                        } else if (m == true) {
                            mirrorMirrorBeenSaid = true;
                            $("#input").text("Listening..."); 
							$("marquee").css('visibility', 'visible');
                        } else {
                            $("#input").text("");
							$("marquee").css('visibility', 'hidden');
                        }
                    } else {
                        if (mirrorMirrorBeenSaid == true) {
                            $("#input").text(output);
                        }
                    }
                }
            }

            var mirrorMirrorBeenSaid = false;
            var karlsruheURL = "http://de.macknet.eu:8000/fire-event";
            var accessToken = "951c47c9f31c467f8871e0723d8545a1";
            var baseUrl = "https://api.api.ai/v1/";
            function send() {
                var text = $("#input").text();
                $.ajax({
                    type: "POST",
                    url: baseUrl + "query?v=20150910",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    headers: {
                        "Authorization": "Bearer " + accessToken
                    },
                    data: JSON.stringify({query: text, lang: "en", sessionId: "007"}),
                    success: function (data) {
                        switch (data.result.parameters.app.toLowerCase()) {
                            case "alarm":
                                sendAlarm(data);
                                break;
                            case "calendar":
                                sendCalendar(data);
                                break;
                            case "weather":
                                sendWeather(data);
                            case "email":
                                sendMail(data);
                            case "map":
                                sendMap(data);
                            case "news":
                                sendNews(data);
                            case "calculator":
                                sendCalculator(data);
                            case "clock":
                                sendClock(data);
                            case "motd":
                                sendMOTD(data);
                            case "list":
                                sendList(data);
                            case "note":
                                sendNote(data);
                            case "music":
                                sendMusic(data);
                            case "timer":
                                sendTimer(data);
                            case "volume":
                                sendVolume(data);
                            case "converter":
                                sendConverter(data);
                            case "translate":
                                sendTranslate(data);
                        }
                        setResponse(JSON.stringify(data, undefined, 2));
                    },
                    error: function () {
                        setResponse("Internal Server Error");
                    }
                });
                setResponse("Working on it...");
            }
            function setResponse(val) {
                $("#response").text(val);

            }

            function sendAlarm(data) {
                var app = data.result.parameters.app.toLowerCase();
                var action = data.result.action;
                var time = data.result.parameters.time;
                var date = data.result.parameters.date;
                var repeat = data.result.parameters.repeat;
                var number = data.result.parameters.number;

                if (action == "addAlarm") {
                    if (repeat == "" && date == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "time", "value": time}]});
                    } else if (date == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "time", "value": time}, {name: "repeat", "value": repeat}]});
                    } else if (repeat == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "time", "value": time}, {name: "date", "value": date}]});
                    }
                } else if (action == "editAlarm") {
                    if (date == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "number", "value": number}, {name: "time", "value": time}]});
                    } else {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "number", "value": number}, {name: "time", "value": time}, {name: "date", "value": date}]});
                    }
                } else if (action == "showAlarm") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "date", "value": date}]});
                } else if (action == "deleteAlarm") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "number", "value": number}]});
                }
            }

            function sendCalendar(data) {
                var app = data.result.parameters.app.toLowerCase();
                var action = data.result.action;
                var month = data.result.parameters.month;
                var date = data.result.parameters.date;
                var period = data.result.parameters.period;
                if (month == "" && date == "" && period == "") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "view", "value": "Calendar"}]});
                } 
                else if (month != "" && date == "" && period == "") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "view", "value": month}]});
                }
                else if (month == "" && date != "" && period == "") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "view", "value": date}]});
                }
                else if (month == "" && date == "" && period != "") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "view", "value": period}]});
                }
            }
            
            function sendMail(data) {
                var app = data.result.parameters.app.toLowerCase();
                var action = data.result.action;
                var date = data.result.parameters.date;
                var period = data.result.parameters.period;
                var type = data.result.parameters.type;
                var givenName = data.result.parameters.senderPerson;
                var givenCompany = data.result.parameters.senderCompany;
                
                if (date == "" && period == "" && type == "" && givenName == "" && givenCompany == "") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "view", "value": "All"}]});
                }
                else if (date != "" && period == "" && type == "" && givenName == "" && givenCompany == "") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "view", "value": "All"}, {name: "date", "value": date}]});
                }
                else if (date == "" && period != "" && type == "" && givenName == "" && givenCompany == "") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "view", "value": "All"}, {name: "period", "value": period}]});
                }
                else if (date == "" && period == "" && type != "" && givenName == "" && givenCompany == "") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "view", "value": "All"}, {name: "type", "value": type}]});
                }
                else if (date == "" && period == "" && type == "" && givenName != "" && givenCompany == "") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "view", "value": "All"}, {name: "fromPerson", "value": givenName}]});
                }
                else if (date == "" && period == "" && type == "" && givenName == "" && givenCompany != "") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "view", "value": "All"}, {name: "fromCompany", "value": givenCompany}]});
                }            
            }
            
            function sendWeather(data) {
                var app = data.result.parameters.app.toLowerCase();
                var action = data.result.action;
                var location = data.result.parameters.location;
                var date = data.result.parameters.date;
                var period = data.result.parameters.period;
                if (date != "" && location != "") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "location", "value": location}, {name: "date", "value": date}]});
                } else if (period != "" && location != "") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "location", "value": location}, {name: "period", "value": period}]});
                } else if (location != "") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "location", "value": location}]});
                } else if (date != "") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "date", "value": date}]});
                } else if (period != "") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "period", "value": period}]});
                }
            }

            function sendMap(data) {
                var app = data.result.parameters.app.toLowerCase();
                var action = data.result.action;
                var userLocation = data.result.parameters.name;
                var city = data.result.parameters.city;
                var country = data.result.parameters.country;
                var continent = data.result.parameters.continent;
                var geocity = data.result.parameters.geocity;
                var geocity1 = data.result.parameters.geocity1;
                if (action == "setMap") {
                    if (geocity != "" && geocity1 == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "distanceTo", "value": geocity}]});
                    } 
                    else if (geocity != "" && geocity1 != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "distanceTo", "value": geocity},{name: "distanceFrom", "value": geocity1}]});
                    } 
                }
                if (action == "showMap") {
                    if (city == "" && country == "" && continent == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "location", "value": "map"}]});
                    } 
                    else if (city != "" && country == "" && continent == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "location", "value": city}]});
                    } 
                    else if (city == "" && country != "" && continent == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "location", "value": country}]});
                    } 
                    else if (city == "" && country == "" && continent != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "date", "value": continent}]});
                    } 
                }
                if (action == "distanceMap") {
                    if (city == "" && country == "" && continent == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "location", "value": "map"}]});
                    } 
                    else if (city != "" && country == "" && continent == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "location", "value": city}]});
                    } 
                    else if (city == "" && country != "" && continent == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "location", "value": country}]});
                    } 
                    else if (city == "" && country == "" && continent != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "date", "value": continent}]});
                    } 
                }
            }
            
            function sendCalculator(data) {
                var app = data.result.parameters.app.toLowerCase();
                var action = data.result.action;
                var number = data.result.parameters.number;
                var number1 = data.result.parameters.number1;
                var calculation = data.result.parameters.calculation;
                if(number != "" && number1 != "" && calculation != "") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "number", "value": number}, {name: "number1", "value": number1}, {name: "calculation", "value": calculation}]});
                }
            } 
            
            function sendNews(data) {
                var app = data.result.parameters.app.toLowerCase();
                var action = data.result.action; 
                var source = data.result.parameters.source;
                
                if (action == "addNews") {
                    if (source != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "add", "value": source}]});
                    }
                } 
                else if (action == "showNews") {
                    if (source == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "show", "value": "all"}]});
                    } else if (source != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "show", "value": source}]});
                    }
                }
            }
     
            function sendClock(data) {
                var app = data.result.parameters.app.toLowerCase();
                var action = data.result.action;
                var city = data.result.parameters.city;
                if(city == "") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "time", "value": "Time"}]});
                }
                else if(city != "") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "city", "value": city}]});
                }
            } 
                                                                                 
            function sendMOTD(data) {
                var app = data.result.parameters.app.toLowerCase();
                var action = data.result.action;
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "action", "value": "view"}]});
            } 
             
            function sendList(data) {
                var app = data.result.parameters.app.toLowerCase();
                var action = data.result.action; 
                var name = data.result.parameters.name;
                var item = data.result.parameters.item;
                var date = data.result.parameters.date;
                
                if (action == "addList") {
                    if (item != "" && name != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "item", "value": item},{name: "name", "value": name}]});
                    }
                } 
                else if (action == "createList") {
                    if (name != "" && item == "" && date == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "name", "value": name}]});
                    } else if (item != "" && name != "" && date == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "name", "value": name},{name: "item", "value": item}]});
                    } else if (item != "" && date != "" name == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "date", "value": date},{name: "item", "value": item}]});
                    }
                }
                else if (action == "deleteList") {
                    if (name != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "delete", "name": "name"}]});
                    }
                }
                else if (action == "removeList") {
                    if (item != "" && name != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "item", "value": item},{name: "name", "value": name}]});
                    }
                }
                else if (action == "showList") {
                    if (name != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "show", "name": "name"}]});
                    }
                }
            }
             
            function sendNote(data) {
                var app = data.result.parameters.app.toLowerCase();
                var action = data.result.action; 
                var name = data.result.parameters.name;
                var text = data.result.parameters.item;
                var number = data.result.parameters.number;
                var date = data.result.parameters.date;
                
                if (action == "addNote") {
                    if (text != "" && name != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "text", "value": text},{name: "name", "value": name}]});
                    }
                } 
                else if (action == "createNote") {
                    if (name != "" && text == "" && date == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "name", "value": name}]});
                    } 
                    else if (text != "" && name != "" && date == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "name", "value": name},{name: "text", "value": text}]});
                    }
                    else if (text != "" && date != "" && name == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "date", "value": date},{name: "text", "value": text}]});
                    }
                }
                else if (action == "deleteNote") {
                    if (name != "" && number == "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "name", "value": name}]});
                    } else if (name == "" && number != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "number", "value": number}]});
                    }
                }
                else if (action == "removeNote") {
                    if (text != "" && name != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "text", "value": text},{name: "name", "value": name}]});
                    }
                }
                else if (action == "showNote") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "show", "name": "All"}]});
                }
            }            
            
            function sendMusic(data) {
                var app = data.result.parameters.app.toLowerCase();
                var action = data.result.action; 
                var artist = data.result.parameters.artist;
                var genre = data.result.parameters.genre;
                var album = data.result.parameters.album;
                var song = data.result.parameters.song;
                var playlist = data.result.parameters.playlist;
                if (action == "play") {
                    if (album != "" && artist != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "album", "value": album}, {name: "artist", "value": artist}]});
                    }
                    else if (genre != "") {
                            $.post(karlsruheURL, {module: app, command: action, params: [{name: "genre", "value": genre}]});
                    } 
                    else if (artist != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "artist", "value": artist}]});
                    } 
                    else if(artist != "" && genre != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "action", "value": "play"}]});
                    }
                    
                }
                else if (action == "nextMusic") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "action", "value": "next"}]});
                }
                else if (action == "previousMusic") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "action", "value": "previous"}]});
                }
                else if (action == "loopMusic") {
                        if (song != "") {
                            $.post(karlsruheURL, {module: app, command: action, params: [{name: "song", "value": song}]});
                        }
                        else if(album != "") {
                            $.post(karlsruheURL, {module: app, command: action, params: [{name: "album", "value": album}]});
                        }
                        else if(artist != "") {
                            $.post(karlsruheURL, {module: app, command: action, params: [{name: "artist", "value": artist}]});
                        }
                }
                else if (action == "shuffleMusic") {
                    if(artist != "") {
                            $.post(karlsruheURL, {module: app, command: action, params: [{name: "artist", "value": artist}]});
                    }
                    else if (genre != "") {
                            $.post(karlsruheURL, {module: app, command: action, params: [{name: "genre", "value": genre}]});
                    }
                    else if(album != "") {
                            $.post(karlsruheURL, {module: app, command: action, params: [{name: "album", "value": album}]});
                    }
                    else if(playlist != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "playlist", "value": playlist}]});
                    }
                    
                }
                else if (action == "pauseMusic") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "action", "value": "pause"}]});
                }
            }
            
            function sendTimer(data) {
                var app = data.result.parameters.app.toLowerCase();
                var action = data.result.action; 
                var duration = data.result.parameters.duration;
                if(action == "setTimer") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "duration", "value": duration}]});
                }
                else if(action == "pauseTimer") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "action", "value": "pause"}]});
                }
                else if(action == "stopTimer") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "action", "value": "stop"}]});
                } 
            }
            
            function sendVolume(data) {
                var app = data.result.parameters.app.toLowerCase();
                var action = data.result.action; 
                var percentage = data.result.parameters.percentage;
                var volume = data.result.parameters.volume;
                if(action == "editVolume") {
                    if(percentage != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "percentage", "value": percentage}]});                        
                    }
                    else if(volume != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "volume", "value": volume}]});
                    }
                }
            }
            
            function sendConverter(data) {
                var app = data.result.parameters.app.toLowerCase();
                var action = data.result.action; 
                var number = data.result.parameters.number;
                var unitFrom = data.result.parameters.unitFrom;
                var unitTo = data.result.parameters.unitTo;
                if(action == "doConverter") {
                    if(number != "" && unitFrom != "" && unitTo != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "number", "value": number},{name: "unitFrom", "value": unitFrom},{name: "unitTo", "value": unitTo}]});                        
                    }
                }
                if(action == "showConverter") {
                    $.post(karlsruheURL, {module: app, command: action, params: [{name: "show", "value": app}]});                        
                    
                }
            }
 
            function sendTranslate(data) {
                var app = data.result.parameters.app.toLowerCase();
                var action = data.result.action; 
                var text = data.result.parameters.text;
                var langFrom = data.result.parameters.languageFrom;
                var langTo = data.result.parameters.languageTo;
                if(action == "doTranslate") {
                    if(number != "" && langFrom != "" && langTo != "") {
                        $.post(karlsruheURL, {module: app, command: action, params: [{name: "text", "value": text},{name: "langFrom", "value": langFrom},{name: "langTo", "value": langTo}]});                        
                    }
                }
            }
            
            recognition.start();
        </script>
        <style type="text/css">
            @font-face {
                font-family: normalFont;
                src: url(CalibriL.ttf);
            }
            html {
                font-family: normalFont;
            }
            body {
                text-align: center;
                margin-top: 40px;

            }
            #input {
                background-color: #fff;
                border: 2px #fff solid;
				width: 90%;
				margin: 0 auto;
                outline: none;
                font-size: 25px;
                text-align: center;
            }
            textarea {
                background-color: #fff;
                border: 1px #8c8c8c solid;
                height: 750px;
                width: calc(100% - 25px);
                outline: none;
                padding: 10px;
                font-size: medium;
                display:none;
            }
            marquee {
                width:200px;
                font-size:35px;
                vertical-align:middle;
                visibility:hidden;
            }
        </style>
    </head>

    <body>
		<div style="width:100%" >
			<div id="input"></div>
			<marquee scrollamount="8" behavior="alternate"><img src="dots.png"></marquee>
		</div>
        <textarea id="response"></textarea> 
    </body>

</html>
